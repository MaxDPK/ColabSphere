<!DOCTYPE html>
<html lang="en">
<head>
    <title>Project Hub</title>
    <!-- PyScript CSS -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <!-- PyScript Core -->
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
</head>
<body>

    <h1>Project: {{ project.name }}</h1>

    <h2>Team Members</h2>
    <ul id="members-list">
        {% for member in members %}
            <li class="member" data-username="{{ member }}">
                {{ member }} - <span class="status">Offline</span>
            </li>
        {% endfor %}
    </ul>

    <a href="/project_whiteboard/{{ project.code }}?user={{ user }}">Go to Whiteboard</a>
    <a href="/gantt_chart?project_code={{ project.code }}&user={{ user }}">Go to Gantt Chart</a>
    <a href="/menu?user={{ user }}">Back to Menu</a>

    <h2>Chats</h2>
    <ul id="chat-list">
        <li class="chat-item" data-chat-id="general1">
            <button class="chat-button" data-chat-id="general1">Open General Chat</button>
        </li>
        {% for chat in project.chats if chat.chat_id != "general1" %}
            <li class="chat-item" data-chat-id="{{ chat.chat_id }}">
                <button class="chat-button" data-chat-id="{{ chat.chat_id }}">
                    Chat with {{ chat.participants | join(', ') }}
                </button>
            </li>
        {% endfor %}
    </ul>

    <!-- PyScript Code -->
    <py-script>
        import asyncio
        from js import document, WebSocket, setTimeout, console, window
        from pyodide.ffi import create_proxy

        class ProjectHub:
            def __init__(self, project_code, username):
                self.project_code = project_code
                self.username = username
                self.ws = None

            async def connect_websocket(self):
                """Establish WebSocket connection and handle events."""
                protocol = "wss" if window.location.protocol == "https:" else "ws"
                ws_url = f"{protocol}://{window.location.host}/ws/{self.project_code}?user={self.username}"
                self.ws = WebSocket.new(ws_url)

                # Create proxies for event handlers
                message_proxy = create_proxy(self.on_message)
                close_proxy = create_proxy(self.on_close)

                # Attach event listeners
                self.ws.addEventListener("message", message_proxy)
                self.ws.addEventListener("close", close_proxy)

            def on_message(self, event):
                """Handle WebSocket messages."""
                js_data = window.JSON.parse(event.data)
                data = dict(js_data.to_py())

                if data["action"] == "update":
                    self.update_online_status(data["online_users"])

            def on_close(self, event):
                """Handle WebSocket disconnection."""
                console.log("‚ùå WebSocket closed. Reconnecting...")
                setTimeout(lambda: asyncio.ensure_future(self.connect_websocket()), 1000)

            def update_online_status(self, online_users):
                """Update the DOM to reflect online/offline status."""
                members_list = document.querySelectorAll(".member")
                for member in members_list:
                    member_username = member.getAttribute("data-username")
                    status_element = member.querySelector(".status")
                    if member_username in online_users:
                        status_element.textContent = "Online"
                        status_element.style.color = "green"
                    else:
                        status_element.textContent = "Offline"
                        status_element.style.color = "red"

        # ‚úÖ Ensure project_code is extracted correctly
        project_code = "{{ project.code }}"
        username = "{{ user }}"

        # ‚úÖ Initialize WebSocket connection
        hub = ProjectHub(project_code, username)
        asyncio.ensure_future(hub.connect_websocket())

        # ‚úÖ Chat Button Handling
        def open_chat(event):
            """Redirect to chat page with the correct project_code."""
            chat_id = event.target.getAttribute("data-chat-id")
            if not chat_id:
                console.warn("‚ö†Ô∏è Chat ID not found in clicked element!")
                return

            url = f"/chat/{chat_id}?user={username}&project_code={project_code}"
            console.log(f"üîÑ Redirecting to: {url}")
            window.location.href = url

        # ‚úÖ Attach event listeners to chat buttons
        chat_buttons = document.querySelectorAll(".chat-button")
        for button in chat_buttons:
            button.addEventListener("click", create_proxy(open_chat))

    </py-script>
</body>
</html>
