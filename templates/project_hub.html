<!DOCTYPE html>
<html lang="en">
<head>
    <title>Project Hub</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <link href="https://fonts.googleapis.com/css2?family=Literata:wght@400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@200&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@100&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">


    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body {
            display: flex;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        h1 {
            font-family: "Amiri Quran", serif;  /* Alternative thin serif font */
            font-weight: 300;  /* Very thin */
            font-size: 48px;
            color: #3B372E;
            letter-spacing: 0.5px;
        }


        .sidebar {
            width: 200px;
            background: #dec5a3;
            padding: 20px;
            height: 100vh;
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
            background: #e6d6c1;
        }
        h2 {
            font-size: 18px;
            color: #354d2f;
        }
        .channel-section, .direct-message-section {
            margin-bottom: 20px;
        }
        .channel-section button {
            display: block;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            padding: 5px;
            text-align: left;
            width: 100%;
        }
        .add-channel {
            display: block;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            padding: 5px;
            text-align: left;
            width: 100%;
            margin-top: 10px;
        }
        .channel-section button:hover, .add-channel:hover {
            background-color: #D9B08C;
        }
        .channel-section button:not(.add-channel)::before {
            content: "# ";
        }

                /* === MODAL OVERLAY (BACKGROUND) === */
        .overlay {
            display: none;  /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* Dark background overlay */
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 6px rgba(0,0,0,0.1);
            z-index: 1001; /* Ensure modal appears above overlay */
            text-align: center;
            width: 300px;
            max-width: 90%;
        }


        /* === MODAL BOX === */
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 6px rgba(0,0,0,0.1);
            z-index: 1001; /* Ensure modal appears above overlay */
            text-align: center;
            width: 300px;
            max-width: 90%;
            opacity: 1;
            visibility: visible;
        }

        /* === MODAL HEADER === */
        .modal-content h2 {
            margin-top: 0;
            font-size: 18px;
            color: #333;
        }

        /* === MODAL INPUT FIELD === */
        .modal-content input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* === BUTTON CONTAINER INSIDE MODAL === */
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        /* === MODAL BUTTONS === */
        .modal-buttons button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Green Confirm Button */
        .modal-buttons button:first-child {
            background: #4CAF50;
            color: white;
        }

        /* Red Cancel Button */
        .modal-buttons button:last-child {
            background: #f44336;
            color: white;
        }

        /* === DROPDOWN MENU FOR RIGHT-CLICK OPTIONS === */
        .dropdown-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            padding: 5px;
            z-index: 1000;
            display: none;
        }

        .dropdown-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .dropdown-menu li {
            padding: 8px 12px;
            cursor: pointer;
        }

        .dropdown-menu li:hover {
            background: #f0f0f0;
        }

        /* === Main Seating Area === */
        .seating-container {
            position: relative;
            width: 600px;
            height: 500px;
            margin: 50px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* === Oval Table in the Center === */
        .table {
            width: 350px;
            height: 200px;
            background-color: #b88c5a;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* === Seats (Chairs) Styling === */
        .seat {
            width: 90px;
            height: 120px;
            background-image: url('/static/chair.png'); /* Use the chair image */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* === Profile Picture on Chair === */
        .profile-pic {
            width: 50px; /* Circular effect */
            height: 50px;
            border-radius: 50%;
            position: absolute;
            top: 15px; /* Adjust so it sits on the chair */
            left: 50%;
            transform: translateX(-50%);
            background-size: cover;
            background-position: center;
            border: 3px solid white; /* Optional */
        }

        /* === User Name under the Profile Picture === */
        .member-name {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            text-align: center;
            position: absolute;
            top: 80px;
        }

        /* === Online Status Indicator === */
        .status-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: green;
            border: 2px solid white;
        }

                /* Project Header - Aligns H1 and Button */
        .project-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Triangle Button (‚ñ∂) */
        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }

        /* Rotated Triangle when Open */
        .toggle-btn.open {
            transform: rotate(90deg);
        }

    </style>
</head>
<body>
    <div class="sidebar">
        <h2>CHANNEL</h2>
        <div id="loading-message">Loading channels...</div>  
        <div class="channel-section" id="channel-list" style="display: none;">  
            <button class="add-channel">+ Add channel</button>
        </div> 
        
        <!-- Right-Click Dropdown Menu for Chat Management -->
        <div id="chat-dropdown" class="dropdown-menu" style="display: none;">
            <ul>
                <li py-click="open_rename_modal">Rename Chat</li>
                <li py-click="open_manage_members_modal">Manage Members</li>
            </ul>
        </div>

        <h2>DIRECT MESSAGE</h2>
        <div class="direct-message-section" id="direct-message-list">
            <p>üßë‚Äçüíª Sam</p>
            <p>üë®‚ÄçüèõÔ∏è John</p>
            <p>üé® Kattie</p>
        </div>
    </div>
    
    <div class="main-content">
        <div class="project-header">
            <h1>Project: {{ project.name }}</h1>
            <button class="toggle-btn" py-click="toggle_project_details">‚ñ∂</button>
        </div>
        
        <!-- Hidden project details initially -->
        <div id="project-details" style="display: none;">
            <h2>Project Code: {{ project.code }}</h2>
            <h3>Team Members:</h3>
            <ul id="member-list">
                {% for member in members %}
                    <li>{{ member }}</li>
                {% endfor %}
            </ul>
        </div>
        
    
        <div class="seating-container">
            <div class="table"></div> <!-- The table -->
            <div id="seating-area"></div> <!-- Seats will be dynamically added here -->
        </div>
        
        
    
        <a href="/project_whiteboard/{{ project.code }}?user={{ user }}">Go to Whiteboard</a>
        <a href="/gantt_chart?project_code={{ project.code }}&user={{ user }}">Go to Gantt Chart</a>
        <a href="/menu?user={{ user }}">Back to Menu</a>
    </div>

        <!-- Rename Chat Modal -->
    <div class="overlay" id="renameModal">
        <div class="modal-content">
            <h2>Rename Chat</h2>
            <input type="text" id="new-chat-name" placeholder="Enter new chat name">
            <div class="modal-buttons">
                <button py-click="rename_chat">Rename</button>
                <button class="cancel-modal-btn" data-modal="renameModal">Cancel</button>

            </div>
        </div>
    </div>

    <div class="overlay" id="manageMembersModal">
        <div class="modal-content">
            <h2>Manage Chat Members</h2>
            
            <div id="member-list"></div> <!-- Members will be inserted here -->
            <div class="modal-buttons">
                <button py-click="update_chat_members">Save</button>
                <button class="cancel-modal-btn" data-modal="manageMembersModal">Cancel</button>
            </div>
        </div>
    </div>
    
    
    


    <!-- Overlay Modal for Adding Channel -->
    <div class="overlay" id="overlay" style="display: none;"></div>
    <div class="modal" id="channelModal" style="display: none;">
        <h2>Create New Channel</h2>
        
        <!-- Channel Name Input -->
        <input type="text" id="channel-name" placeholder="Enter channel name" required>

        <!-- Member Selection -->
        <h3>Select Members:</h3>
        <div id="member-selection">
            {% for member in members %}
                <label>
                    <input type="checkbox" class="member-checkbox" value="{{ member }}">
                    {{ member }}
                </label><br>
            {% endfor %}
        </div>

        <div class="modal-buttons">
            <button id="create-channel-btn">Create</button>
            <button id="cancel-modal-btn">Cancel</button>
        </div>
    </div>



    <py-script>
        import asyncio
        import json
        from js import document, WebSocket, setTimeout, console, window
        from pyodide.ffi import create_proxy
        from pyodide.http import pyfetch
        import math
        
        class ProjectHub:
            def __init__(self, project_code, username):
                self.project_code = project_code
                self.username = username
                self.ws = None
        
                # Create persistent proxies for WebSocket event listeners
                self.message_proxy = create_proxy(self.on_message)
                self.close_proxy = create_proxy(self.on_close)
        
            async def connect_websocket(self):
                protocol = "wss" if window.location.protocol == "https:" else "ws"
                ws_url = f"{protocol}://{window.location.host}/ws/{self.project_code}?user={self.username}"
                self.ws = WebSocket.new(ws_url)
        
                self.ws.addEventListener("message", self.message_proxy)
                self.ws.addEventListener("close", self.close_proxy)
        
            def on_message(self, event):
                js_data = window.JSON.parse(event.data)
                data = dict(js_data.to_py())
                if data["action"] == "update":
                    self.update_online_members(data["online_users"])
            
        
            def on_close(self, event):
                console.log("\u274c WebSocket closed. Reconnecting...")
                setTimeout(lambda: asyncio.ensure_future(self.connect_websocket()), 1000)
        
            def update_online_members(self, online_users):
                seating_area = document.getElementById("seating-area")
                seating_area.innerHTML = ""
        
                # Positions to arrange chairs around the table
                num_seats = len(online_users)
                radius = 170  # Distance from the center
                table_center_x = 250
                table_center_y = 220
        
                angle_step = 360 / max(num_seats, 1)  # Spread evenly around the table
        
                for i, (member, profile_pic_url) in enumerate(online_users.items()):
                    angle = math.radians(i * angle_step)
                    seat_x = table_center_x + radius * math.cos(angle)
                    seat_y = table_center_y + radius * math.sin(angle)
        
                    seat = document.createElement("div")
                    seat.classList.add("seat")
                    seat.style.left = f"{seat_x}px"
                    seat.style.top = f"{seat_y}px"
        
                    profile_pic = document.createElement("div")
                    profile_pic.classList.add("profile-pic")
                    profile_pic.style.backgroundImage = f"url('{profile_pic_url}')"
        
                    status_indicator = document.createElement("div")
                    status_indicator.classList.add("status-indicator")
        
                    seat.appendChild(profile_pic)
                    seat.appendChild(status_indicator)
                    seating_area.appendChild(seat)
            
        
        project_code = "{{ project.code }}"
        username = "{{ user }}"
        hub = ProjectHub(project_code, username)
        asyncio.ensure_future(hub.connect_websocket())
        selected_chat_id = None  
        
        async def fetch_channels():
            """
            Fetches channels where the logged-in user is a participant.
            """
            try:
                response = await pyfetch(f"/get_channels?project_code={{ project.code }}&user={{ user }}", method="GET")
                data = await response.json()

                if "channels" in data:
                    channel_list = document.getElementById("channel-list")
                    loading_message = document.getElementById("loading-message")

                    # ‚úÖ Find "+ Add Channel" button before clearing channels
                    add_channel_button = document.querySelector(".add-channel")

                    # ‚úÖ Remove only chat buttons (keep + Add Channel)
                    channel_list.innerHTML = ""  
                    channel_list.appendChild(add_channel_button)  # ‚úÖ Re-add the button

                    # ‚úÖ Add only chats the user is a member of
                    for channel in data["channels"]:
                        add_channel_to_ui(channel)

                    # ‚úÖ Hide loading message & show channels
                    loading_message.style.display = "none"
                    channel_list.style.display = "block"

            except Exception as e:
                console.log(f"Error fetching channels: {str(e)}")


        
        def add_channel_to_ui(channel_name):
            """
            Dynamically adds a chat button with right-click functionality.
            """
            new_button = document.createElement("button")
            new_button.textContent = f" {channel_name}"
            new_button.classList.add("chat-button")
            new_button.dataset.chatId = channel_name
            new_button.setAttribute("onclick", f"location.href='/chat/{channel_name}?user={{ user }}&project_code={{ project.code }}'")
            
            # ‚úÖ Attach right-click event (PyScript)
            new_button.addEventListener("contextmenu", create_proxy(lambda event: show_chat_dropdown(event, channel_name)))
            
            document.getElementById("channel-list").appendChild(new_button)   
            
        
        
        async def save_channel(channel_name):
            """
            Sends a request to save a newly created channel with selected members.
            """
            try:
                # ‚úÖ Get all selected members
                member_checkboxes = document.querySelectorAll(".member-checkbox:checked")
                selected_members = [checkbox.value for checkbox in member_checkboxes]
        
                # ‚úÖ Ensure we have at least one member
                if not selected_members:
                    console.log("‚ö†Ô∏è Error: At least one member must be selected!")
                    return
                
                form_data = json.dumps({
                    "project_code": project_code, 
                    "channel_name": channel_name,
                    "members": selected_members  # ‚úÖ Include selected members in request
                })
                
                response = await pyfetch(
                    "/add_channel", 
                    method="POST", 
                    body=form_data, 
                    headers={"Content-Type": "application/json"}
                )
                
                data = await response.json()
                console.log(data["message"])
        
                # Refresh the list of channels
                await fetch_channels()
            
            except Exception as e:
                console.log(f"Error saving channel: {str(e)}")
    
        def openModal(event=None):
            """
            Opens the Add Channel modal.
            """
            document.getElementById("overlay").style.display = "block"
            document.getElementById("channelModal").style.display = "block"
            
        def closeModal(event=None):
            """
            Closes the Add Channel modal.
            """
            document.getElementById("overlay").style.display = "none"
            document.getElementById("channelModal").style.display = "none"
            
        # Create persistent proxies for event handlers
        openModal_proxy = create_proxy(openModal)
        closeModal_proxy = create_proxy(closeModal)
       
        
        async def addChannel(event=None):
            """
            Handles the creation of a new channel.
            """
            channel_name = document.getElementById("channel-name").value.strip()
            if channel_name:
                await save_channel(channel_name)
            closeModal()
        
        addChannel_proxy = create_proxy(addChannel)
        
        def setup_event_listeners():
            """
            Sets up event listeners to avoid the borrowed proxy issue.
            """
            add_channel_button = document.querySelector(".add-channel")
            create_channel_btn = document.getElementById("create-channel-btn")
            cancel_modal_btn = document.getElementById("cancel-modal-btn")
        
            if add_channel_button:
                add_channel_button.addEventListener("click", openModal_proxy)
            if create_channel_btn:
                create_channel_btn.addEventListener("click", addChannel_proxy)
            if cancel_modal_btn:
                cancel_modal_btn.addEventListener("click", closeModal_proxy)
        
        # Wait for DOM to load before setting up event listeners
        setTimeout(create_proxy(setup_event_listeners), 100)
        asyncio.ensure_future(fetch_channels())

        
        
        def setup_modal_listeners():
            """
            Ensures Rename and Manage Members modals open when clicked.
            """
            dropdown_menu = document.getElementById("chat-dropdown")
            
            if not dropdown_menu:
                console.log("‚ùå Dropdown menu not found!")
                return

            rename_btn = dropdown_menu.querySelector("li:nth-child(1)")  # Rename Chat
            manage_members_btn = dropdown_menu.querySelector("li:nth-child(2)")  # Manage Members

            if rename_btn:
                rename_btn.addEventListener("click", create_proxy(open_rename_modal))
                console.log("‚úÖ Rename modal event attached!")

            if manage_members_btn:
                manage_members_btn.addEventListener("click", create_proxy(open_manage_members_modal))
                console.log("‚úÖ Manage members modal event attached!")

        # Run the setup once the DOM loads
        setTimeout(create_proxy(setup_modal_listeners), 100)


        def show_chat_dropdown(event, chat_id):
            """
            Displays the dropdown menu when the user right-clicks on a chat.
            """
            global selected_chat_id
            selected_chat_id = chat_id  # ‚úÖ Store selected chat ID
            event.preventDefault()  # Prevent default right-click menu

            dropdown = document.getElementById("chat-dropdown")
            dropdown.style.display = "block"
            dropdown.style.left = f"{event.pageX}px"
            dropdown.style.top = f"{event.pageY}px"

            console.log(f"üü¢ Chat dropdown opened for: {selected_chat_id}")

            # Hide dropdown when clicking elsewhere
            def hide_dropdown(evt):
                dropdown.style.display = "none"
                console.log("üî¥ Dropdown closed.")

            document.addEventListener("click", create_proxy(hide_dropdown), {"once": True})

        def open_rename_modal(event=None):
            """
            Opens the rename chat modal and ensures it is visible.
            """
            global selected_chat_id
            if not selected_chat_id:
                console.log("‚ùå No chat selected!")
                return
        
            console.log(f"üü¢ Rename modal opened for chat: {selected_chat_id}")
        
            rename_modal = document.getElementById("renameModal")
            overlay = document.getElementById("overlay")

            rename_modal.style.display = "flex"
            rename_modal.style.display = "block"
            overlay.style.display = "block"  # ‚úÖ Ensure overlay appears
            rename_modal.style.zIndex = "1001"  # ‚úÖ Bring modal to the front
        
        def open_manage_members_modal(event=None):
            """
            Opens the manage members modal and loads the current members.
            """
            global selected_chat_id
            if not selected_chat_id:
                console.log("‚ùå No chat selected!")
                return
        
            console.log(f"üü¢ Manage members modal opened for chat: {selected_chat_id}")
        
            manage_modal = document.getElementById("manageMembersModal")
            overlay = document.getElementById("overlay")
        
            manage_modal.style.display = "flex"
            overlay.style.display = "block"
            manage_modal.style.zIndex = "1001"
        
            asyncio.ensure_future(fetch_chat_members())  # Fetch and display members
        
        def rename_chat(event=None):
            if not selected_chat_id:
                console.log("No chat selected!")
                return

            new_chat_name = document.getElementById("new-chat-name").value

            async def send_rename_request():
                response = await pyfetch("/rename_chat", method="POST", body=json.dumps({
                    "project_code": "{{ project.code }}",
                    "chat_id": selected_chat_id,
                    "new_name": new_chat_name
                }), headers={"Content-Type": "application/json"})

                await response.json()
                document.location.reload()

            asyncio.ensure_future(send_rename_request())

        def close_modal(event):
            """
            Closes the specified modal and hides the overlay.
            """
            button = event.target
            modal_id = button.getAttribute("data-modal")  # Get modal ID from button data attribute
        
            if modal_id:
                modal = document.getElementById(modal_id)
                overlay = document.getElementById("overlay")
        
                if modal:
                    modal.style.display = "none"
                if overlay:
                    overlay.style.display = "none"
        
                console.log(f"üî¥ Modal {modal_id} closed.")
        
        
        def attach_cancel_events():
            """
            Attaches event listeners to all cancel buttons.
            """
            cancel_buttons = document.querySelectorAll(".cancel-modal-btn")
            
            for btn in cancel_buttons:
                btn.addEventListener("click", create_proxy(close_modal))
            
        setTimeout(create_proxy(attach_cancel_events), 100)
            
        
        async def fetch_chat_members():
            """
            Fetches all project members and highlights members already in the selected chat.
            """
            global selected_chat_id
            if not selected_chat_id:
                console.log("‚ùå No chat selected!")
                return
            
            try:
                response = await pyfetch(f"/get_chat_members?project_code={project_code}&chat_id={selected_chat_id}", method="GET")
                data = await response.json()
        
                member_list_div = document.getElementById("member-list")
                member_list_div.innerHTML = ""  # ‚úÖ Clear previous content to prevent duplicates
        
                # ‚úÖ Ensure only one "Select All" option exists
                select_all_checkbox = document.createElement("input")
                select_all_checkbox.type = "checkbox"
                select_all_checkbox.id = "select-all"
                select_all_checkbox.addEventListener("change", create_proxy(select_all_members))
                
                label = document.createElement("label")
                label.textContent = " Select All"
                label.insertBefore(select_all_checkbox, label.firstChild)
        
                member_list_div.appendChild(label)
                member_list_div.appendChild(document.createElement("br"))
        
                # ‚úÖ Add each project member with checkboxes
                for member_data in data["members"]:
                    member = member_data["username"]
                    is_member = member_data["is_member"]
        
                    checkbox = document.createElement("input")
                    checkbox.type = "checkbox"
                    checkbox.value = member
                    checkbox.checked = is_member  # ‚úÖ Pre-check if already in chat
                    checkbox.classList.add("member-checkbox")
        
                    label = document.createElement("label")
                    label.textContent = f" {member}"
                    label.insertBefore(checkbox, label.firstChild)
        
                    member_list_div.appendChild(label)
                    member_list_div.appendChild(document.createElement("br"))
        
            except Exception as e:
                console.log(f"Error fetching chat members: {str(e)}")
    



        def select_all_members(event):
            """
            Toggles all checkboxes based on 'Select All' checkbox state.
            """
            is_checked = event.target.checked
            checkboxes = document.querySelectorAll("#member-list input[type='checkbox']")
            
            for checkbox in checkboxes:
                checkbox.checked = is_checked


        async def update_chat_members(event=None):
            """
            Sends updated members list to the backend.
            """
            global selected_chat_id
            if not selected_chat_id:
                console.log("‚ùå No chat selected!")
                return

            selected_members = [checkbox.value for checkbox in document.querySelectorAll(".member-checkbox:checked")]

            try:
                response = await pyfetch("/update_chat_members", method="POST", body=json.dumps({
                    "project_code": project_code,
                    "chat_id": selected_chat_id,
                    "members": selected_members
                }), headers={"Content-Type": "application/json"})

                data = await response.json()
                console.log(data["message"])
                
                # Reload the page to reflect changes
                document.location.reload()

            except Exception as e:
                console.log(f"Error updating chat members: {str(e)}")


        def toggle_project_details(event=None):
            """
            Toggles the visibility of the project details section.
            """
            details_div = document.getElementById("project-details")
            toggle_btn = document.querySelector(".toggle-btn")

            if details_div.style.display == "none":
                details_div.style.display = "block"
                toggle_btn.classList.add("open")  # Rotate triangle
            else:
                details_div.style.display = "none"
                toggle_btn.classList.remove("open")  # Reset rotation
                        
        
    </py-script>
 
</body>
</html>