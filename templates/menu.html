<!DOCTYPE html>
<html lang="en">
<head>
    <title>Project Hub</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Lalezar' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Albert Sans' rel='stylesheet'>
    <link rel="stylesheet" href="./static/menu.css">
</head>
<body data-project-code="{{ project.code if project and project.code else '' }}">




    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="profile-container">
            <img src="{{ profile_pic | safe }}" alt="Profile Picture" class="profile-pic">
            <span class="username">{{ user }}</span>
        </div>

        <a href="#" class="sidebar-button" id="openModal">
            <img src="/static/new.png" alt="New Project" class="sidebar-icon"> Create new
        </a>
        <a href="#" class="sidebar-button" id="joinProject">
            <img src="/static/join.png" alt="Join Project" class="sidebar-icon"> Join project
        </a>
        
        
        

        <div class="sidebar-section">
            <h3>Recent</h3>
            <div class="recent-projects">
                {% for project in recent_projects %}
                    <a href="/project_hub/{{ project.code }}?user={{ user }}" class="recent-project">{{ project.name }}</a>
                {% endfor %}
            </div>
        </div>
        

        <div class="sidebar-section">
            <h3>Upcoming deadline</h3>
            <ul class="upcoming-deadlines">
                <li>AI Model Training - Feb 29</li>
                <li>Website Launch - Mar 5</li>
            </ul>
        </div>

        <a href="/logout" class="logout-btn">‚Æê</a>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <input type="text" class="search-bar" id="searchInput" placeholder="Search for project" />


        <h1>Projects</h1>
        <div class="projects-container">
            {% for project in projects %}
                <div class="project-card" onclick="window.location.href='/project_hub/{{ project.code }}?user={{ user }}'">
                    <span class="project-title">{{ project.name }}</span>
                    
                    <div class="member-list">
                        {% for member in project.members %}
                            <img src="{{ member.profile_pic | safe }}" alt="{{ member.username }}" class="member-pic">
                        {% endfor %}
                    </div>
        
                    <div class="project-progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ project.overall_progress }}%;"></div>
                        </div>
                        <span class="progress-text">{{ project.overall_progress }}%</span>
                    </div>
        
                    <!-- ‚úÖ New: Project Status and Days Remaining -->
                    <div class="project-meta">
                        <span class="project-status">
                            Status: 
                            {% if project.status == 'Completed' %}
                                ‚úÖ Completed
                            {% elif project.status == 'Overdue' %}
                                ‚ùå Overdue
                            {% else %}
                                üîÑ Ongoing
                            {% endif %}
                        </span><br>
                        
                        {% if project.days_remaining is not none %}
                            <span class="project-days-left">
                                {{ project.days_remaining }} day{{ 's' if project.days_remaining != 1 else '' }} remaining
                            </span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
        
        
        <!-- Modal for Adding Tasks -->
        <div class="overlay" id="overlay"></div>
        <div class="modal" id="taskModal">
            <h2>Add Task</h2>
            <p id="selectedDate"></p>
            <input type="text" id="taskInput" placeholder="Enter task" />
            <button id="saveTask">Save</button>
        </div>
    </div>

    <!-- Modals -->
    <div class="overlay" id="overlay"></div>
    <div class="modal" id="modal">
        <h2>Create New Project</h2>
        <form method="POST" action="/create_project">
            <input type="text" name="project_name" placeholder="Enter project name" required>
            <button type="submit">Create</button>
        </form>
    </div>

    <div class="modal join-modal" id="joinModal">
        <h2>Join Project</h2>
        <form method="POST" action="/join_project">
            <input type="text" name="project_code" placeholder="Enter project code" required>
            <button type="submit">Join</button>
        </form>
    </div>

    <py-script type="py">
        import js
        from js import document, console, fetch
        from pyodide.http import pyfetch
        from pyodide.ffi import create_proxy
        import asyncio
        from datetime import datetime, timedelta
        import json
        

        

        BASE_URL = "http://127.0.0.1:8000"  # Adjust if your FastAPI server is running elsewhere.

        today = datetime.today()
        current_year = today.year
        current_month = today.month
        month_names = [
            "January", "February", "March", "April", "May", "June", 
            "July", "August", "September", "October", "November", "December"
        ]

        day_names = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]
    
        def open_modal(event):
            document.getElementById("modal").style.display = "block"
            document.getElementById("overlay").style.display = "block"
    
        def open_join_modal(event):
            document.getElementById("joinModal").style.display = "block"
            document.getElementById("overlay").style.display = "block"
    
        def close_modal(event):
            document.getElementById("modal").style.display = "none"
            document.getElementById("joinModal").style.display = "none"
            document.getElementById("overlay").style.display = "none"
    
        document.getElementById("openModal").addEventListener("click", create_proxy(open_modal))
        document.getElementById("joinProject").addEventListener("click", create_proxy(open_join_modal))
        document.getElementById("overlay").addEventListener("click", create_proxy(close_modal))
    
        async def fetch_recent_projects():
            """Fetch recent projects dynamically and update the sidebar."""
            user_element = document.querySelector(".username")
            if not user_element:
                return  # Ensure username element exists before proceeding
            
            user = user_element.textContent.strip()
            url = f"/get_recent_projects?user={user}"
            
            try:
                response = await pyfetch(url)
                data = await response.json()
                recent_projects = data.get("recent_projects", [])
    
                # Ensure recent projects container exists
                recent_container = document.querySelector(".sidebar-section h3 + div")  # Selects the div under "Recent"
                if not recent_container:
                    return
                
                recent_container.innerHTML = ""  # Clear old list
    
                # Add updated recent projects
                for project in recent_projects:
                    project_element = document.createElement("a")
                    project_element.href = f"/project_hub/{project['code']}?user={user}"
                    project_element.className = "recent-project"
                    project_element.textContent = project["name"]
                    recent_container.appendChild(project_element)
            
            except Exception as e:
                print(f"Error updating recent projects: {e}")
        
       

        def search_projects(event):
            """Filter projects dynamically based on search input."""
            search_query = document.getElementById("searchInput").value.lower()
            project_cards = document.querySelectorAll(".project-card")

            for card in project_cards:
                title = card.querySelector(".project-title").textContent.lower()
                if search_query in title:
                    card.style.display = "block"  # Show matching projects
                else:
                    card.style.display = "none"  # Hide non-matching projects

        # Attach the event listener for real-time search filtering
        document.getElementById("searchInput").addEventListener("input", create_proxy(search_projects))


        
    
        

    </py-script>

</body>
</html>
